#!/usr/bin/env python
"""
    %prog run

run can be a csv
"""

import sys
import biggles
import esutil as eu
import nsim

import numpy
from numpy import sqrt

from optparse import OptionParser
parser=OptionParser(__doc__)
parser.add_option('--index',default=0,
                  help='which shear component to plot')
parser.add_option('-y','--yrange',default='-0.02,0.02',
                  help='y range')
parser.add_option('-x','--xrange',default=None,
                  help='x range')

parser.add_option('--s2n-field',default='s2n_matched',
                  help="field for s2n")

parser.add_option('--eps',default=None,
                  help="eps file to write")
parser.add_option('--png',default=None,
                  help="png file to write")

#parser.add_option('--labels',default=None,
#                  help="labels for each run")

parser.add_option('--method',default='ba',
                  help="method to plot ('lensfit,'ba','gmean')")

parser.add_option('--with-lensfit',action='store_true',
                  help="overplot lensfit results")
parser.add_option('--add-run-label',action='store_true',
                  help="lable run as well")
parser.add_option('--use-scatter',action='store_true',
                  help="use scatter about zero for error; only works if unbiased!")

parser.add_option('--panel',default=None,
                  help="labels for the panel")
parser.add_option('--noshow',action='store_true',
                  help="don't show on the screen")

def get_names(method):
    if method == 'BA':
        s_name='shear'
        scov_name='shear_cov'
    elif method=='LENSFIT':
        s_name='shear_lensfit'
        scov_name='shear_lensfit_cov'
    elif method=='GMEAN':
        s_name='g_sum'
        scov_name='shear_cov'
    else:
        raise ValueError("bad method: '%s'" % method)

    return s_name, scov_name

def get_method_name(method):
    if method=='BA':
        return 'B&A'
    else:
        return method

def plot_run(plt, c, index, symbol, color, linestyle, options,
             with_points=True, with_curve=True,
             method='BA', with_lensfit=False,
             add_run_label=False):

    label = c['simc']['label']
    if add_run_label:
        label='%s %s' % (c['run'].replace('run-',''), label )
    shear_true=c['simc']['shear'][index]

    url=nsim.files.get_averaged_url(c['run'], 0)
    print url
    data=eu.io.read(url)

    s_name,scov_name=get_names(method)
    if s_name=='g_sum':
        shear=data['g_sum'][:,index]/data['nsum']
    else:
        shear=data[s_name][:,index]
    err=sqrt(data[scov_name][:,index,index])


    s2n_vals = data[options.s2n_field]

    if options.xrange is None:
        xrng=[0.75*s2n_vals[0], 1.25*s2n_vals[-1]]
    else:
        xrng=options.xrange.split(',')
        xrng=[float(xr) for xr in xrng]


    if index==0:
        yvals = shear/shear_true-1
        yerr = err/shear_true
        yvals_lensfit = data['shear_lensfit'][:,0]/shear_true-1
    else:
        yvals = shear-shear_true
        yerr = err
        yvals_lensfit = data['shear_lensfit'][:,0]

    if options.use_scatter:
        print 'using scatter'
        w,=numpy.where( (s2n_vals >= xrng[0]) & (s2n_vals <= xrng[1]) )
        print s2n_vals[w]
        yerr = yvals[w].std()
        yerr=numpy.array([yerr]*shear.size,dtype='f8')


    pts = biggles.Points(s2n_vals, 
                         yvals,
                         type=symbol,
                         size=2,
                         color=color)
    ep = biggles.SymmetricErrorBarsY(s2n_vals,
                                     yvals,
                                     yerr,
                                     width=2,
                                     color=color)
    crv = biggles.Curve(s2n_vals, 
                        yvals,
                        type=linestyle,
                        width=2,
                        color=color)

    crv.label=label
    pts.label=label
    if with_points:
        plt.add(pts,ep)

    if with_curve and not with_lensfit:
        plt.add(crv)

    if with_lensfit and method != 'lensfit':
        crv_lensfit = biggles.Curve(s2n_vals, 
                                    yvals_lensfit,
                                    type=linestyle,
                                    width=2,
                                    color=color)
        plt.add(crv_lensfit)


    return xrng, crv, pts

def get_labels(runs, options):
    if options.labels is None:
        labels=runs
    else:
        labels=options.labels.split(',')
        labels=[r'$%s$' % l for l in labels]
        if len(labels) != len(runs):
            raise ValueError("Labels must have same length as runs")

    return labels

def main():
    options,args = parser.parse_args(sys.argv[1:])

    if len(args) < 1:
        parser.print_help()
        sys.exit(45)

    runs=args
    method=options.method.upper()
    index=int( options.index )

    biggles.configure('default','fontsize_min',3)
    biggles.configure('_HalfAxis','ticks_size',2)
    biggles.configure('_HalfAxis','subticks_size',1)

    colors=['darkblue','red',     'darkgreen','magenta',
            'blue',    'firebrick','orange',   'purple']
    linestyles=['solid','dotdashed','shortdashed','dotted',
                'longdashed','dotdotdashed','dotdotdotdashed']
    symbols=['filled circle','filled triangle','filled square','filled diamond',
             'circle',       'triangle',       'square',       'diamond']
    #labels=get_labels(runs, options)

    if index==0:
        ylabel=r'$\Delta \gamma/\gamma$'
    else:
        ylabel=r'$\Delta \gamma$'

    if options.s2n_field=='s2n_matched':
        xlabel=r'$(S/N)_{matched}$'
    elif options.s2n_field=='flux_s2n':
        xlabel=r'$(S/N)_{flux}$'
    elif options.s2n_field=='T_s2n':
        xlabel=r'$(S/N)_{size}$'
    else:
        xlabel=options.s2n_field

    yrng=options.yrange.split(',')
    yrng=[float(yr) for yr in yrng]


    plt=biggles.FramedPlot()

    plt.xlabel=xlabel
    plt.ylabel=ylabel
    plt.aspect_ratio=1
    plt.xlog=True
    plt.add( biggles.FillBetween([1.e-6,5000], [0.004,0.004], 
                                  [1.e-6,5000], [-0.004,-0.004],
                                  color='grey90') )
    plt.add( biggles.FillBetween([1.e-6,5000], [0.002,0.002], 
                                  [1.e-6,5000], [-0.002,-0.002],
                                  color='grey80') )

    plt.add( biggles.Curve([1.e-6,5000],[0,0]) )

    
    plt.yrange=yrng

    cobj=[]
    for irun,run in enumerate(runs):
        with_curve=False

        c = nsim.files.read_config(run)
        c['simc'] = nsim.files.read_config(c['sim'])

        xrng_run, crv_run, pts_run = plot_run(plt, c, index,
                                              symbols[irun],
                                              colors[irun],
                                              linestyles[irun],
                                              options,
                                              #labels[irun],
                                              with_curve=with_curve,
                                              method=method,
                                              with_lensfit=options.with_lensfit,
                                              add_run_label=options.add_run_label)
        if with_curve:
            cobj.append(crv_run)
        else:
            cobj.append(pts_run)

        if irun==0:
            xrng=xrng_run
        else:
            xrng[0] = min(xrng[0],xrng_run[0])
            xrng[1] = max(xrng[1],xrng_run[1])
    
    key=biggles.PlotKey(0.9,0.9,cobj,halign='right')
    plt.add(key)
    plt.xrange=xrng

    #tl=biggles.PlotLabel(0.9,0.17,r'$\gamma_{true} = %.02f$' % c['simc']['shear'][index],
    #                     halign='right')
    #plt.add(tl)

    #method_name=get_method_name(method)
    #ml=biggles.PlotLabel(0.9,0.1,method_name, halign='right')
    #plt.add(ml)


    if options.panel is not None:
        l=biggles.PlotLabel(0.1,0.9,options.panel,
                            halign='left')
        plt.add(l)

    if not options.noshow:
        plt.show()

    if options.png:
        print options.png
        plt.write_img(800,800,options.png)
    if options.eps:
        print options.eps
        plt.write_eps(options.eps)
main()
